<!DOCTYPE html>
<html>
<head>
    <!-- Auth0 SPA SDK (CDN) -->
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.11/auth0-spa-js.production.js" defer></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'media'
        }
    </script>
    <title>Bulb Sequence Editor</title>
    <style>
        .color-preview {
            width: 40px;
            height: 40px;
            display: inline-block;
            border: 2px solid #e5e7eb;
            border-radius: 0.375rem;
            vertical-align: middle;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
    </style>
    <script src="/iro.min.js"></script>
    <script src="/toggle-json.js"></script>
    <script src="/parse-sequence.js"></script>
    <script src="/sequence-ui.js"></script>
    <script src="/auth0-init.js" defer></script>
    <script src="/auth0-owner-check.js" defer></script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <div class="max-w-5xl mx-auto p-6">
        <!-- Auth Controls -->
        <div class="flex items-center justify-between mb-6 p-4 bg-white dark:bg-gray-800 rounded-lg shadow">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Bulb Sequence Editor</h1>
            <div id="auth0-controls" class="flex items-center gap-3">
                <button id="loginBtn" class="hidden px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Log In</button>
                <button id="logoutBtn" class="px-4 py-2 bg-gray-600 dark:bg-gray-700 text-white rounded-lg hover:bg-gray-700 dark:hover:bg-gray-600 transition">Log Out</button>
                <span id="userInfo" class="text-gray-700 dark:text-gray-300 font-medium"></span>
            </div>
        </div>

        <!-- Sequence Selector -->
        <div class="mb-6 p-5 bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="flex items-center gap-4 flex-wrap">
                <label class="font-semibold text-gray-700 dark:text-gray-300 flex items-center gap-2">
                    <span>Sequence:</span>
                    <select id="sequenceSelector" class="px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></select>
                </label>
                <button type="button" id="newSequenceBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">New Sequence</button>
                <button type="button" id="deleteSequenceBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Delete</button>
                <label class="ml-auto flex items-center gap-2 font-medium text-gray-700 dark:text-gray-300">
                    <input type="checkbox" id="sequenceEnabledCheckbox" class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                    <span>Enabled (for cron)</span>
                </label>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="mb-6 p-4 bg-white dark:bg-gray-800 rounded-lg shadow flex items-center gap-4 flex-wrap">
            <label class="flex items-center gap-2 font-medium text-gray-700 dark:text-gray-300">
                <input type="checkbox" id="liveSyncCheckbox" class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                <span>Live Bulb Sync</span>
            </label>
            <button id="playSequenceBtn" type="button" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">Play</button>
            <button id="nextStepBtn" type="button" class="hidden px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Next Step</button>
            <button type="button" id="bulbOnBtn" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition">Turn Bulb On</button>
            <button type="button" id="bulbOffBtn" class="px-4 py-2 bg-gray-700 dark:bg-gray-600 text-white rounded-lg hover:bg-gray-800 dark:hover:bg-gray-700 transition">Turn Bulb Off</button>
            <span id="bulbStatus" class="ml-auto font-semibold text-gray-800 dark:text-gray-200"></span>
        </div>

        <!-- Editor UI -->
        <div id="editorUI" class="hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <button id="toggleJsonBtn" type="button" onclick="toggleJson()" class="mb-4 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">Show Advanced JSON Editor</button>
                
                <div id="jsonEditor" class="hidden mb-6 p-4 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700">
                    <form id="seqForm">
                        <label class="block mb-2 font-medium text-gray-700 dark:text-gray-300">Paste Sequence JSON:</label>
                        <textarea id="seqJson" rows="8" class="w-full p-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 dark:text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"></textarea>
                        <button type="button" onclick="parseSequence()" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Parse & Visualize</button>
                    </form>
                </div>

                <div id="manualEntry">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Manual Entry</h3>
                    <button type="button" onclick="addStep()" class="mb-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Add Step</button>
                    <div id="steps" class="space-y-2"></div>
                </div>

                <!-- Color Picker Modal -->
                <div id="colorPickerModal" class="hidden fixed top-1/4 left-1/2 -translate-x-1/2 bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 z-50 border border-gray-200 dark:border-gray-700">
                    <div id="colorPicker"></div>
                    <div class="mt-4 flex gap-3">
                        <button id="applyColorBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">Apply</button>
                        <button id="cancelColorBtn" class="px-4 py-2 bg-gray-600 dark:bg-gray-700 text-white rounded-lg hover:bg-gray-700 dark:hover:bg-gray-600 transition">Cancel</button>
                    </div>
                </div>

                <hr class="my-6 border-gray-200 dark:border-gray-700">
                
                <div class="flex items-center gap-4 mb-4 flex-wrap">
                    <label class="flex items-center gap-2 font-medium text-gray-700 dark:text-gray-300">
                        <span>Start Time:</span>
                        <input type="time" id="startTime" class="px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </label>
                    <label class="flex items-center gap-2 font-medium text-gray-700 dark:text-gray-300">
                        <span>Duration (minutes):</span>
                        <input type="number" id="duration" min="1" value="60" class="w-24 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 dark:text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </label>
                </div>
                
                <button onclick="saveSequence()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium text-lg">Save Sequence to KV</button>
                <div id="result" class="mt-4 text-gray-800 dark:text-gray-200 font-medium"></div>
            </div>
        </div>
    </div>
</body>
</html>
